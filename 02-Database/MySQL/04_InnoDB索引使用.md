- [索引命名规范](#索引命名规范)
- [查询优化](#查询优化)
    - [1. 减少SQL返回的数据量](#1-减少sql返回的数据量)
    - [2. 分解大连接查询](#2-分解大连接查询)
    - [3. 优化索引效率](#3-优化索引效率)
- [索引失效场景](#索引失效场景)
    - [1. 联合索引最左前缀匹配](#1-联合索引最左前缀匹配)
    - [2. 在索引列上进行计算可能导致索引失效](#2-在索引列上进行计算可能导致索引失效)
    - [3. LIKE中缀和后缀查询索引失效](#3-like中缀和后缀查询索引失效)
    - [4. 类型转换可能会导致索引失效](#4-类型转换可能会导致索引失效)
    - [5. or条件导致索引失效](#5-or条件导致索引失效)
  - [6. !=/ not in不走覆盖索引会失效；](#6--not-in不走覆盖索引会失效)
- [索引优化场景](#索引优化场景)
    - [1. 将区分度高的列尽可能放在复合索引前部](#1-将区分度高的列尽可能放在复合索引前部)
    - [2. 最小化索引创建](#2-最小化索引创建)
    - [3. update条件必须使用索引列](#3-update条件必须使用索引列)
    - [4. 排序场景](#4-排序场景)

# 索引命名规范
- 主键：`pk_[column]`
- 唯一索引：`uk_[column]_[column]`
- 联合索引：`idx_[column]_[column]`

# 查询优化

### 1. 减少SQL返回的数据量
**只返回必要的列**；

1、过多的数据，占用带宽、网络资源、传输效率；

2、过多的数据从磁盘加载进buffer pool，挤占内存，可能导致其他缓存失效，也可以说是污染buffer pool；

### 2. 分解大连接查询

1、大的连接查询的缓存容易失效；其中一个表变化了，整个缓存失效；多个单表缓存，互相之间不影响；

2、连表查询不利于业务扩展；
- 不利于服务的切分；
- 不利于分库分表；

### 3. 优化索引效率

1、尽量使用索引；

2、尽量使用覆盖索引；


# 索引失效场景

### 1. 联合索引最左前缀匹配
创建原则：根据具体业务，尽可能的综合多个SQL来创建联合索引；

使用联合索引原则：

1、遵循最左匹配原则；查询条件尽量保持索引顺序；

2、当联合索引中间某个值使用了范围查询，后续索引列可能失效；

3、通常使用最多的列，创建的时候靠前；

详见：[[MySQL/3. InnoDB索引#索引分类#Secondary Indexes(辅助索引)|B+Tree联合索引原理]]


### 2. 在索引列上进行计算可能导致索引失效

对索引列执行了函数、表达式等计算，会使索引失效；**尽量对条件的值进行计算，而不是对列进行计算**；
- 不走索引：`from_unixtime(create_time) = ’2019-12-01’`
- 走索引：`create_time = unix_timestamp(’2019-12-01’)`

### 3. LIKE中缀和后缀查询索引失效
LIKE模糊查询时，使用`'%xxxx'、'%xxxx%`**中后缀模糊匹配**，则必须先获取原值，再判断右侧是否匹配，所以也是不能走索引的；
- 使用前缀模糊匹配可用用到索引；
- 一定要后缀查询，可用存储的时候reverse；

### 4. 类型转换可能会导致索引失效
- **字符串列使用数字查询，会使索引失效**；MySQL并不确定字符串的列的每个值都能转为数字，所以要把每一列进行字符串转数字；相当于对列进行计算；
- **数字列使用字符串查询，不会使索引失效**；直接将查询条件转为数字即可；


### 5. or条件导致索引失效

参与`or`的列中，有索引列，有非索引列，则会导致索引失效；

## 6. !=/ not in不走覆盖索引会失效；


# 索引优化场景

### 1. 将区分度高的列尽可能放在复合索引前部
区分度高的列放在前面，能够优先过滤掉更多的数据，加快定位；

计算区分度：`count(distinct col) / count(*)`

唯一索引区分度最高，一条索引唯一对应一条记录；

### 2. 最小化索引创建
索引占用空间、降低了写的性能；避免没有必要的索引；

### 3. update条件必须使用索引列
如果update的where条件没有使用索引列，会锁表；

### 4. 排序场景

- 排序最好使用索引列排序，同时如果是联合索引，排序列
- 如果 `group by` 需要统计的数据量不大，尽量只使用内存临时表；可以通过适当调大 `tmp_table_size` 参数，来避免用到磁盘临时表；
