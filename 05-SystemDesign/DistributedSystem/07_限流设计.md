- [设计原则](#设计原则)
	- [功能性设计](#功能性设计)
- [限流算法](#限流算法)
	- [计数器限流算法](#计数器限流算法)
	- [滑动窗口算法(Rolling window)](#滑动窗口算法rolling-window)
	- [漏桶算法](#漏桶算法)
	- [令牌桶算法](#令牌桶算法)
- [限流方案](#限流方案)
- [限流组件](#限流组件)
		- [Sentinel](#sentinel)
		- [Nginx](#nginx)
		- [Kubernetes Ingress](#kubernetes-ingress)
		- [Hystrix](#hystrix)
		- [Redis RateLimiter](#redis-ratelimiter)
		- [Guava RateLimiter](#guava-ratelimiter)

# 设计原则
## 功能性设计
1、需要流量监控能力；

2、灵活、可定制的限流策略；(拒绝策略)
- 直接拒绝请求、快速失败；
- 降级处理请求；
- 请求排队；

3、支持预热模型；

当程序长期处于冷状态，程序内的连接池、线程池可能存在线程没有完全启动的情况，也包括JIT即时编译没有立刻检测到热点代码，都可能导致大流量突然到来时，无法及时处理的情况；

预热功能：

- 可以将请求排队，控制流量缓慢增加，逐步增加QPS；
- 模拟请求，利用JIT的热点编译特性，提前预热 热点的接口；

4、高性能、低延时、可靠性；

# 限流算法

## 计数器限流算法

1、设定时间窗口`window`、窗口内限流次数`limit`；
2、记录当前窗口请求次数，超出limit则拒绝，否则放通；
3、进入下一个窗口，重置limit；
优势：
- 实现简单；
缺陷：
- 如果大量请求集中在两个窗口中间，正好跨过窗口的边界，就可能无法准确限流

## 滑动窗口算法(Rolling window)

1、设定`window`大小(1s)、`limit`大小、最小粒度(200ms)

2、将时间窗口window以更小的力度划分，当窗口到达尾部，向后推移一个最小粒度；

3、当窗口长度 >= 1s，每过200ms，向后推进一个滑块，队首减去一个滑块；
- 每次请求到达，记录数+1；
- 每次滑动：当前请求数 - 队首请求数；

4、当请求数达到limit，在下次滑动之前，拒绝后续请求；

优势：
- 可以设定更小的时间尺度；
- 有记忆性；
缺陷：
- 同计数器限流一样，不准确；

## 漏桶算法

1、设定固定的bucket容量大小capacity、固定的`流出速率rate`、记录最后一次请求at；

2、每次请求到达，计算bucket内当前容量；满则拒绝；

3、恒定速率消费bucket内的请求；相当于为服务屏蔽突发流量；
```go
capacity int；// bucket固定大小
time at;   // 记录上次请求at
function allow(){
	wb = (now - at) * rate // 两个请求间 处理了多少请求
	w = max((w-wb),0)      // 当前容量
	
	if (w < capacity){  // 是否满
		return true     // 放通
	} else {
		return false    // 拒绝
	}
}
```

缺陷：
- **处理请求的速率固定**，适合于请求处理绝对均匀的服务；
- **无法处理突发大流量**，即使服务器负载不高，也会恒定处理，产生排队、积压；

## 令牌桶算法

1、设定`token bucket大小`，`投放token的速率rate`；

2、请求到达，有token则处理，无则排队等待或拒绝；

3、恒定速率向bucket填充token，但不限制消费token的速率，允许激增流量；

优势：
- **Token可以积攒，允许突发请求**，只要存在token，获取token的速率不受限制；

# 限流方案

1、基于共享缓存：本地内存限流多个接口、分布式缓存限流多节点；

2、基于消息队列：延迟、异步处理请求；

# 限流组件

### Sentinel
Sentinel是目前业界主流的限流器，专门针对后端定制的限流器；提供：
- 多样的流量控制：
	- 设置不同的方案：QPS、线程数限流；
	- 处理方式：快速失败、基于漏桶的匀速排队、预热模式；
- 熔断降级：防止雪崩；
- 负载均衡
- 实时监控


### Nginx
Nginx通过限流模块实现限流功能，通用性较强：
- 控制速率：ngx_http_limit_req_module(漏桶算法)
- 控制并发数(连接数)：ngx_http_limit_conn_module

### Kubernetes Ingress
通过 kubernetes Controller + Nginx 实现负载均衡；
云原生负载均衡的解决方案；

### Hystrix
Netflix开源的限流组件，已经停止维护了；一般不使用了；

### Redis RateLimiter
分布式限流方案，基于令牌桶算法；
- 扩展性强，可以基于此方案实现多样化限流；如做注解接口限流、IP限流；

### Guava RateLimiter
单节点限流方案，基于令牌桶算法；