
# 消息投递语义

指：消息从生产端，到broker，再到消费端，消息传递的保证；

3种语义：最多一次、最小一次、精确一次

> Kafka自身只能保证：最少一次，要保证精确一次，需要业务自行保证幂等；

## 生产端

**最多一次**：生产者只发一次，无论成功失败；（最多有一个消息投递成功）
- 不会重复、但可能失败；
- 达成条件：ack=1、分区副本>=2、ISR队列副本>=2
  
**最少一次**：生产者未收到成功响应，进行重试；（最少有一个消息投递成功）
- 不会失败，但是可能重复
- 达成条件：ack=0

**精确一次**：既不重复、也不丢失；
- 同时保证发送可靠、发送幂等；详见6-生产者；
- 条件：发送实现幂等 + ack=1、分区副本>=2、ISR队列副本>=2

## 消费端

消费端需要做两件事：消费、提交offset；

**最多一次**：先提交offset，再消费，最多消费一次，可能消费失败；
- 提交offset成功，消费失败；
- 提交offset失败，仍可以消费，所以最多一次

**最少一次**：先消费，再提交offset，可能重复消费；
- offset提交失败，则会重复消费；
- 消费失败，offset不变，仍可以消费，所以最少一次；

**精确一次**：手动提交 + 消费端借助其他组件的事务支持，实现事务；
