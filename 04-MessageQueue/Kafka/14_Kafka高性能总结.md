
[Kafak-Doc-Efficiency](https://kafka.apache.org/documentation/#maximizingefficiency)

# 1. Parition的并行消费

当消费者数量对应Partition数量，可以达到最大消费速率；

可以增加Partition数量，横向扩展并行度；

# 2. 生产消费批处理
批量发送 和 批量拉取极大提升吞吐量；

# 3. 零拷贝技术
减少数据拷贝次数，线程上下文切换次数；

- 索引文件：mmap + write；通常是消费端指定offset读取时用到；
- 消息文件：sendfile；通过索引，找到消息后，通过sendfile发送消息；

# 4. 顺序写/顺序读/磁盘预读

- **顺序写**只需要数据写入时间，减少寻道、磁头旋转时间

- 大量利用page cache，**写数据不需要真正写入磁盘**；

- **读操作可以利用磁盘预读**，连续读取多个页面，减少磁盘IO；

# 5. 稀疏索引 + 二分搜索

**二分搜索** + **稀疏索引** 实现高效查询操作(通过时间戳和offset)
- 通过时间戳和offset 进行二分搜索；
- 稀疏索引：多条消息才会生成一个索引；

## 6. 消息压缩

消耗一定的CPU，提高网络传输效率，提高吞吐量；

- 生产端可用通过配置：`compression.type = gzip`对消息进行单个或批量压缩；减少数据大小；
- 生产端同样配置有压缩算法；当与生产端压缩算法相同，则不需要解压缩，并且能够用到零拷贝；
  - 当压缩算法不一致，就需要对数据进行解压，再次压缩，势必需要将数据拷贝到用户空间进行处理；
  - 当压缩算法一致，不需要对消息进行额外处理，
- 消费端直接拉取压缩的数据，在客户端进行解压缩；