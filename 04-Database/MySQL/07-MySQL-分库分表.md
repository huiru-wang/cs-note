# 何时分库分表

分库分表的原因都是太大，但是这个大，有很多个原因：

1. <font color="#de7802">数据库压力大</font>：用户请求太大，需要分散请求到多个服务器上；
	- 增加主机来分担请求；这个应该属于主从；

2. <font color="#de7802">单库太大</font>：<font color="#de7802">垂直切分</font>；单个数据库的处理能力有限，磁盘空间不足，IO瓶颈等问题，需要切分为多个小库；

3. <font color="#de7802">单表太大</font>：<font color="#de7802">水平切分</font>；索引膨胀(索引文件随着数据量增加不断膨胀)，查询超时，需要且分为多个更小的表；
  

# 分片策略

1、单纯哈希分片：
按照某个或多个字段，进行Hash取模分片；

- 难以横向扩展；

  

2、范围分片：Id增长分片/时间增长分片

  

3、业务相关性分片；

  

# 分库分表设计

1、选择合适的拆分策略；(路由策略)

根据已经出现/预计可能出现的性能问题，决定如何拆分；

- 表字段过多，或者存在大字段，考虑垂直拆分；(一般在设计之初就应该考虑)

- 表数据量逐渐膨胀，导致查询压力大、索引膨胀等情况，考虑水平拆分

  

2、如果是水平拆分，需要考虑水平拆分维度：

如何拆分，才能保证数据分布均匀、良好的可扩展性；
- 数据分布均匀：拆分的目的就是提高并发性能，如果数据分布不均匀，就会影响性能；
- 可扩展性：拆分之后，应当在满足业务增长的同时，能够有良好扩展性，可维护性；

  

例如：
- 可以按照顺序拆分：从0到10000一个表，10001到20000一个表；
- Hash取模拆分：取用户id，然后hash取模，分配到不同的数据库上；
- 按地区拆分：比如按照华东，华南，华北这样来区分业务；
- 按时间拆分：将6个月前，甚至一年前的数据切出去放到另外的一张表，因为随着时间流逝，这些表的数据 被查询的概率变小，所以没必要和“热数据”放在一起，这个也是“冷热数据分离”。

3、合适的拆分工具：Sharding-JDBC
4、实现层面：数据路由；
5、根据业务调整索引，进行性能测试、优化等；
- 垂直拆分可能涉及重建索引；

  

# 分表后复杂查询

  